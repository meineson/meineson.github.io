<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="MEINESON,meineson@gmail.com"><title>从0开发网页webrtc sip软电话(支持自建sip服务器freeswitch) · MBSTUDIO</title><meta name="description" content="最近在调试基于web的sip开发库（有sip.js和jssip两家），原理都差不多，都是通过SIP RFC的websocket扩展（SIP over WebSocket RFC 7118，标准情况下是UDP、TCP或TLS传输方式），通过ws消息传递标准sip消息（目前主流VoIP平台，例如：Ast"><meta name="keywords" content="mbstudio,ICT,RCS,Deep Learning,Digital Twin,AIGC"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">MBSTUDIO</a></h3><div class="description"><p>魔瓶工作室 since 2001 /RCS OS IOT AI DigitalTwin/</p></div></div></div><ul class="social-links"><li><a href="mailto:meineson@gmail.com"><i class="fa fa-envelope">         </i></a></li><li><a target="_blank" rel="noopener" href="https://weibo.com/meineson"><i class="fa fa-weibo"></i></a></li><li><a target="_blank" rel="noopener" href="http://github.com/meineson"><i class="fa fa-github"></i></a></li></ul><div class="footer"></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/me.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>从0开发网页webrtc sip软电话(支持自建sip服务器freeswitch)</a></h3></div><div class="post-content"><p>最近在调试基于web的sip开发库（有sip.js和jssip两家），原理都差不多，都是通过SIP RFC的websocket扩展（SIP over WebSocket RFC 7118，标准情况下是UDP、TCP或TLS传输方式），通过ws消息传递标准sip消息（目前主流VoIP平台，例如：Asterisk,Freeswitch,Kamillo等均有支持），然后通过浏览器webrtc进行音视频编解码和rtp通信。<br>需求的来源也很简单，目前类似<a target="_blank" rel="noopener" href="https://www.pjsip.org/">PJSIP</a>的C&#x2F;C++的sip开发库虽然已经非常成熟，但native开发始终是个门槛，尤其是界面开发（之前曾经开发定制过一款单exe的mbphone sip软电话，可以说80%工作量都花在界面上了，还是在使用了duilib库的前提下），现在想找齐Windows、Linux、Mac三平台都简洁好用的SIP软电话都非常困难，更不用说开发集成了，尤其是现在WEB应用和移动应用普及的时代，开发全平台的软件成本太高。</p>
<p>webrtc的开源平台和客户端sdk开发解决方案似乎很多，github一拉都齐活，但仔细试下来，由于webrtc的开放性并没有定义应用层通信协议，所以许多开发者大多是另起炉灶采用私有应用层通信协议，甚至ws+http混用，与标准程控交换机IPPBX、呼叫中心、视频会议等现有设施并不兼容（一般是通过这些Webrtc平台额外提供的sip网关进行转接，商用的zoom、腾讯会议也是类似解决方案）。</p>
<p>如果需要开发标准的SIP软电话，就需要开发5个原生的客户端（例如采用PJSIP，支持windows、Android、iOS、Linux、MacOS全平台），对于中小公司和个人开发者几乎不现实，所以视线还是回到跨平台特别是web解决方案上来。</p>
<p>早几年，各家开源sip通信平台对于websocket的支持还不太成熟，例如freeswitch当时实现的webrtc软电话方案，是通过verto方案折中实现verto就是一个私有的应用层协议，它并不与sip协议兼容，而且文档也不完备，除了直接使用它提供的verto软电话，并不具备太多个性化定制能力。<br>好在freeswitch最新1.10版本上，sip的websocket支持已经可用了，而基于javscript的sip协议栈例如<a target="_blank" rel="noopener" href="https://sipjs.com/">sip.js</a>和<a target="_blank" rel="noopener" href="https://jssip.net/">Jssip</a>也非常成熟了，所以通过WEB实现标准的sip通信成为可能。</p>
<hr>
<ul>
<li><strong>开发服务器</strong></li>
</ul>
<p>使用docker快速搭建一个支持websocket的sip服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#docker pull safarov/freeswitch</span><br><span class="line">#docker run -d --name fs -v  ~/fscfg:/etc/freeswitch --net=host safarov/freeswitch</span><br></pre></td></tr></table></figure>
<p><small>我们这里使用host网络，避免映射太多端口的麻烦以及docker网络性能的瓶颈，因为sip通信需要海量的udp端口段。<br>我们这里还映射了容器内配置文件目录到主机fscfg目录下，方便修改配置文件。</small></p>
<ul>
<li><strong>ICE服务器（stun、turn）</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#docker run -d --name ice --network=host coturn/coturn</span><br></pre></td></tr></table></figure>
<p>由于webrtc强制ICE进行网络协商，在sip服务器上或另一台服务器上架设coturn服务器以支持ICE协商。</p>
<ul>
<li><strong>开发服务器基本配置</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#cd ~/fscfg/</span><br><span class="line">#nano vars.xml</span><br><span class="line">&lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_password=mbstudio&quot;/&gt;</span><br><span class="line">&lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;domain=172.21.2.210&quot;/&gt;</span><br><span class="line">&lt;X-PRE-PROCESS cmd=&quot;stun-set&quot; data=&quot;external_rtp_ip=172.21.2.210&quot;/&gt;</span><br><span class="line">&lt;X-PRE-PROCESS cmd=&quot;stun-set&quot; data=&quot;external_sip_ip=172.21.2.210&quot;/&gt;</span><br><span class="line"></span><br><span class="line">#nano autoload_configs/switch.conf.xml</span><br><span class="line">    &lt;!-- RTP port range --&gt;</span><br><span class="line">    &lt;param name=&quot;rtp-start-port&quot; value=&quot;8000&quot;/&gt;</span><br><span class="line">    &lt;param name=&quot;rtp-end-port&quot; value=&quot;8100&quot;/&gt;</span><br><span class="line"></span><br><span class="line">#nano autoload_configs/acl.conf.xml </span><br><span class="line">    &lt;list name=&quot;wan.auto&quot; default=&quot;allow&quot;&gt;</span><br><span class="line">      &lt;node type=&quot;allow&quot; cidr=&quot;172.21.0.0/16&quot;/&gt;  #fix coturn 488 error</span><br><span class="line">    &lt;/list&gt;    </span><br><span class="line"></span><br><span class="line">#nano autoload_configs/event_socket.conf.xml  </span><br><span class="line">    &lt;param name=&quot;listen-ip&quot; value=&quot;0.0.0.0&quot;/&gt;   #fix fs_cli.c:1699 main() Error Connecting []  </span><br></pre></td></tr></table></figure>
<small>
以上，分别修改了上述容器实例内置的1000-1019共20个测试账号的初始密码为mbstudio，测试账号在配置文件夹fscfg/directory/default/目录下，以10xx.xml格式保存。
由于是内网测试，不启用stun外网地址探测和nat穿透等功能，手工设置为主机ip地址。还修改了rtp端口范围（如果不使用host网络要手工映射端口的话）。</small>

<ul>
<li><strong>启动服务器端调试</strong></li>
</ul>
<p>应用上述修改并打开调试开关（主要是打印sip消息方便调试）。<br>使用sip软电话或硬件sip电话机注册到服务器，例如账号1000，密码mbstudio，注册地址是172.21.2.210（端口5060）。<br><img src="/images/2025-06-30-10-19-39.png" alt="image"><br>其中，transport可以手工指定sip通信协议使用tcp还是udp（默认）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#docker restart fs</span><br><span class="line">#docker exec -ti fs fs_cli</span><br><span class="line">fs&gt;sofia global siptrace on   #打开sip消息调试开关</span><br><span class="line">+OK Global siptrace on</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">...</span><br><span class="line">SIP/2.0 200 OK</span><br><span class="line">Via: SIP/2.0/TCP 172.21.2.202:65297;rport=65297;branch=z9hG4bKPj2e3d5eaf-5b9c-4e40-98f4-1f242c1fca62;alias</span><br><span class="line">From: &quot;1000&quot; &lt;sip:1000@172.21.2.210&gt;;tag=558a0010-8079-48ec-a1e4-47929619cd01</span><br><span class="line">To: &quot;1000&quot; &lt;sip:1000@172.21.2.210&gt;;tag=HXvtBgX2Fa94B</span><br><span class="line">Call-ID: 24489094-f40d-47fd-87e8-1c30eba35fa0</span><br><span class="line">CSeq: 4 REGISTER</span><br><span class="line">Date: Thu, 26 Jun 2025 02:01:24 GMT</span><br><span class="line">User-Agent: FreeSWITCH-mod_sofia/1.10.12-release-10222002881-a88d069d6f+git~20240802T210227Z~a88d069d6f~64bit</span><br><span class="line">Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, MESSAGE, INFO, UPDATE, REGISTER, REFER, NOTIFY, PUBLISH, SUBSCRIBE</span><br><span class="line">Supported: timer, path, replaces</span><br><span class="line">Content-Length: 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>能看到上述200 OK消息表示服务器已经正常工作。</p>
<ul>
<li><strong>sip开发库准备</strong></li>
</ul>
<p>下载最新的JSSIP库：<a target="_blank" rel="noopener" href="https://jssip.net/download/releases/jssip-3.10.0.js">https://jssip.net/download/releases/jssip-3.10.0.js</a><br>发布时可用: <a target="_blank" rel="noopener" href="https://jssip.net/download/releases/jssip-3.10.0.min.js">https://jssip.net/download/releases/jssip-3.10.0.min.js</a> 减少体积。</p>
<blockquote>
<p>这里暂时不选择sip.js是因为其最新版本已经完全采用ts语言开发了，需要编译、发布才能使用。虽然也提供了UMD的js文件，但其文档和demo完全只讲ts，对新手非常不友好。<br>私以为，现在web应用开发不论规模就上ts，各种包依赖、编译、打包发布，丢掉了web开发的天生的源码开放性、简洁性和可读性，题外话了。</p>
</blockquote>
<ul>
<li><strong>web sip软电话开发步骤</strong></li>
</ul>
<p>新建一个html页面，引入jssip库，配置sip服务器wss地址和用户名密码，并注册回调函数启动sip ua，关键代码如下:</p>
<ol>
<li>SIP账号注册在线</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">index.html:</span><br><span class="line">&lt;script src=&quot;./jssip-3.10.0.js&quot;&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">mbphone.js:</span><br><span class="line">const server = &#123;</span><br><span class="line">  domain: &#x27;172.21.2.210&#x27;,</span><br><span class="line">  wsServers: &#x27;wss://172.21.2.210:7443&#x27;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const user = &#123;</span><br><span class="line">    disName: &#x27;test 1000&#x27;,</span><br><span class="line">    name: &#x27;1000&#x27;,</span><br><span class="line">    authName: &#x27;1000&#x27;,</span><br><span class="line">    authPwd: &#x27;mbstudio&#x27;,</span><br><span class="line">    regExpires: 180</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var socket = new JsSIP.WebSocketInterface(server.wsServers);</span><br><span class="line">var configuration = &#123;</span><br><span class="line">  sockets  : [ socket ],</span><br><span class="line">  display_name: user.disName,</span><br><span class="line">  uri      : &#x27;sip:&#x27;+user.name+&#x27;@&#x27;+server.domain,</span><br><span class="line">  contact_uri: &#x27;sip:&#x27;+user.name+&#x27;@&#x27;+server.domain,</span><br><span class="line">  authorization_user: user.authName,</span><br><span class="line">  password : user.authPwd,</span><br><span class="line">  register_expires: user.regExpires,</span><br><span class="line">  user_agent: &#x27;MBWebPhone 1.0&#x27;</span><br><span class="line">&#125;;</span><br><span class="line">//https://jssip.net/documentation/api/ua_configuration_parameters/#parameter_authorization_user</span><br><span class="line"></span><br><span class="line">var myPhone = new JsSIP.UA(configuration);</span><br><span class="line">myPhone.on(&#x27;connected&#x27;, function(e)&#123; </span><br><span class="line">  console.log(&#x27;connected&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line">myPhone.on(&#x27;disconnected&#x27;, function(e)&#123; </span><br><span class="line">  console.log(&#x27;disconnected&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line">myPhone.on(&#x27;newRTCSession&#x27;, function(e)&#123; </span><br><span class="line">  console.log(&#x27;newRTCSession&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line">myPhone.on(&#x27;newMessage&#x27;, function(e)&#123; </span><br><span class="line">  console.log(&#x27;newMessage&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line">myPhone.on(&#x27;registered&#x27;, function(e)&#123; </span><br><span class="line">  console.log(&#x27;registered&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line">myPhone.on(&#x27;unregistered&#x27;, function(e)&#123; </span><br><span class="line">  console.log(&#x27;unregistered&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line">myPhone.on(&#x27;registrationFailed&#x27;, function(e)&#123; </span><br><span class="line">  console.log(&#x27;registrationFailed&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">myPhone.start();</span><br></pre></td></tr></table></figure>
<p>在浏览器中直接打开index.html，如果一切正常的话，console中会不报错并提示connected， registered。<br>并且sip服务器端也应该可以看到正常的注册消息200 OK，表示1000在线了。</p>
<blockquote>
<p>注意：<br>fs的默认wss监听地址是7443，同时，由于是内网IP时址，没有正确的ssl证书，第一次运行时会直接报错websocket无法连接，需要手工在浏览器里输入 <a target="_blank" rel="noopener" href="https://172.21.2.210:7443/">https://172.21.2.210:7443</a> 在弹出的警告页面里手工允许访问，后续demo就可以正常连接了。</p>
</blockquote>
<ol start="2">
<li>发起呼叫</li>
</ol>
<p>代码中先写死被叫号码，例如1002（提前在电脑或手机上使用其它软件或硬件注册在线）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">index.html:</span><br><span class="line">&lt;div class=&quot;video&quot;&gt;</span><br><span class="line">  &lt;video id=&quot;remote-video&quot; width=&quot;100%&quot; muted=&quot;muted&quot;&gt;</span><br><span class="line">    &lt;p&gt;Your browser doesn&#x27;t support HTML5 video.&lt;/p&gt;</span><br><span class="line">  &lt;/video&gt;</span><br><span class="line">  &lt;div class=&quot;video-local&quot;&gt;</span><br><span class="line">    &lt;video id=&quot;local-video&quot; width=&quot;100%&quot; muted=&quot;muted&quot;&gt;</span><br><span class="line">      &lt;p&gt;Your browser doesn&#x27;t support HTML5 video.&lt;/p&gt;</span><br><span class="line">    &lt;/video&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;   </span><br><span class="line"></span><br><span class="line">mbphone.js：</span><br><span class="line">var views = &#123;</span><br><span class="line">  &#x27;selfView&#x27;:   document.getElementById(&#x27;local-video&#x27;),</span><br><span class="line">  &#x27;remoteView&#x27;: document.getElementById(&#x27;remote-video&#x27;)</span><br><span class="line">&#125;;</span><br><span class="line">var eventHandlers = &#123;</span><br><span class="line">  &#x27;progress&#x27;:   function(data)&#123; </span><br><span class="line">    console.log(&quot;calling&quot;);</span><br><span class="line">   &#125;,</span><br><span class="line">  &#x27;failed&#x27;:     function(data)&#123; </span><br><span class="line">    console.log(&quot;call failed&quot;);</span><br><span class="line">   &#125;,</span><br><span class="line">  &#x27;confirmed&#x27;:  function(data)&#123; </span><br><span class="line">    console.log(&quot;call confirmed&quot;);</span><br><span class="line">   &#125;,</span><br><span class="line">  &#x27;ended&#x27;:      function(data)&#123; </span><br><span class="line">    console.log(&quot;call ended&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line">var options = &#123;</span><br><span class="line">  &#x27;eventHandlers&#x27;: eventHandlers,</span><br><span class="line">  &#x27;mediaConstraints&#x27;: &#123;&#x27;audio&#x27;: true, &#x27;video&#x27;: true&#125;,</span><br><span class="line">  sessionTimersExpires: 3600  //过短也会呼叫失败</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const callee = 1002;</span><br><span class="line">myPhone.call(&#x27;sip:&#x27;+callee+&#x27;@&#x27;+server.domain, options);</span><br></pre></td></tr></table></figure>

<p>刷新页面，会弹出权限麦克风和摄像头权限窗口，允许后自动呼叫1002。<br><img src="/images/2025-06-30-13-46-14.png" alt="image"></p>
<p>由于局域网没有stun和ice服务器，配置是清空的，呼叫时报错：<br><code>SIP/2.0 488 Not Acceptable Here</code></p>
<p>查看fs打印的日志，原因是jssip错误地在sdp中携带了类似：<br><code>a=candidate:1302296363 1 udp 2113937151 a807f338-fbf2-45a9-ba04-90a2cb5763dd.local 63851 typ host generation 0 network-cost 999</code><br>其中：a807f338-fbf2-45a9-ba04-90a2cb5763dd.local是非法地址（其实是chrome浏览器的隐私保护隐藏了本机IP，旧版本就是本地IP地址），导致<code>mod_sofia.c:2588 CODEC NEGOTIATION ERROR.</code><br><code>switch_core_media.c:4197 Drop audio Candidate cid: 1 proto: udp type: host addr: a807f338-fbf2-45a9-ba04-90a2cb5763dd.local:63851 (not an IP address)</code><br>回复488消息中携带了：<br><code>Reason: Q.850;cause=88;text=&quot;INCOMPATIBLE_DESTINATION&quot;</code></p>
<p>解决办法是加入stun或ice服务器，让jssip能够探测到本机的正常ip地址，局域网方案则是内网搭建coTurn服务器：<br>非常折腾但是没办法，这些问题类似webrtc强制https，wss，强制媒体dtls、srtp加密等等，rtp通信协商也是强制ICE，这些只能去适应webrtc开发者google的规范和定义，要跳过这些限制只能使用原生的C&#x2F;C++开发客户端SIP软电话，就可以不受制约了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var options = &#123;</span><br><span class="line">  ...</span><br><span class="line">  &#x27;pcConfig&#x27;: &#123;</span><br><span class="line">    &#x27;iceServers&#x27;: [&#123;urls: &#x27;stun:172.21.2.210:3478&#x27;&#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>调试jssip</li>
</ol>
<p>浏览器console中输入：<br><code>JsSIP.debug.enable(&#39;JsSIP:*&#39;);</code><br>重新加载页面即可看到sip消息日志。<br>关闭调试则同样的：<br><code>JsSIP.debug.disable(&#39;JsSIP:*&#39;);</code></p>
<ol start="4">
<li>调试webrtc</li>
</ol>
<p><code>chrome://webrtc-internals/</code><br>可以查看当前活动的rtc媒体通信，例如媒体收发端口，速率，编码等，调试单通、卡顿等SIP通信中常见问题。</p>
<blockquote>
<p>提示：目前demo中，始终使用设备默认的麦克风、扬声器和摄像头建立呼叫，并且JSSIP文档中毫无相关介绍怎么修改。这是因为jssip的作者也是SIP over WebSocket RFC 7118的作者，学者一般比较有个性，认为这一块是属于浏览器的webrtc的API管的，jssip不掺和。<br>所以准备下一篇文章介绍下webrtc通信中怎么配合jssip实现枚举、选取音视频设备，音视频编解码启用、禁用及优先级设置，视频清晰度设置等功能。<br>介绍一本webrtc好书：<a target="_blank" rel="noopener" href="https://webrtcforthecurious.com/zh/">https://webrtcforthecurious.com/zh/</a></p>
</blockquote>
<ol start="5">
<li>进一步开发提示</li>
</ol>
<p>如上，具备了一个sip软电话的基本功能，注册在线，自动发起呼叫。<br>进一步需要开发：（不定时更新在线demo及源码）</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 将用户名、密码可配置，wss服务器地址配死或自动分发。</li>
<li><input checked="" disabled="" type="checkbox"> 监测注册事件，提示在线、离线状态和错误（例如：用户名、密码不对，网络中断离线自动重注册等）。</li>
<li><input checked="" disabled="" type="checkbox"> 通过手工输入号码呼叫，或者拉取通讯录电话号码点击号码，或者实现传统的电话数字拨号盘方式发起呼叫。</li>
<li><input checked="" disabled="" type="checkbox"> 监测呼叫事件，例如振铃、接通、无人应答、无法接通等状态，来电时提示接通或自动应答。</li>
<li><input checked="" disabled="" type="checkbox"> 呼叫或应答时，可选仅音频或视频通话。</li>
<li><input disabled="" type="checkbox"> 增加通话挂断、呼叫保持（hold）、静音等功能按钮。</li>
<li><input disabled="" type="checkbox"> 本地webrtc实现录音、录像保存功能。</li>
<li><input disabled="" type="checkbox"> 以及，开发一个友好美观的web功能界面或网页悬浮按钮通话插件。</li>
</ul>
<p>在线demo：<a href="https://mbstudio.cn/mbwebphone-demo">https://mbstudio.cn/mbwebphone-demo</a><br><small>提示：上述demo演示只有web部署，依然会在你的本地局域网172.21.2.210地址上去找freeswitch连接wss。</small><br>源码：<a target="_blank" rel="noopener" href="https://github.com/meineson/mbwebphone">https://github.com/meineson/mbwebphone</a> </p>
<p><img src="/images/2025-07-07-16-22-28.png" alt="image"><br><img src="/images/2025-07-07-16-22-36.png" alt="image"><br><img src="/images/2025-07-07-16-43-09.png" alt="image"></p>
<blockquote>
<p>注意：如果是直接打开html文件方式进行开发调试，浏览器每次都会弹屏申请摄像头、麦克风权限。<br>如果以localhost或局域网IP方式，以http方式部署web服务开发调试，chrome系浏览器会提示不安全站点，并禁止打开摄像头、麦克风。<br>需要手动启用参数，例如：<code>chrome://flags#unsafely-treat-insecure-origin-as-secure=http://172.21.2.203:4444,http://localhost:4444</code> 才能使特定站点（你的局域网web服务地址，精确到端口）在http协议下能够取得多媒体设备权限。并且，此时你可以不使用wss而是ws了，例如修改mbphone.js中的<code>wsServers: &#39;ws://172.21.2.210:5066&#39;</code> 使用freeswitch的ws端口进行sip websocket通信，为下一篇文章开发客户端程序埋下伏笔。<br>如果局域网内以https方式部署web服务开发调试，由于ssl证书一般都是自签发的浏览器不认，需要在浏览器手动忽略警告继续访问（包括web服务端口和wss两个端口）。</p>
</blockquote>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2025-06-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/融合通信/" title="融合通信">融合通信 </a><a class="tag" href="/tags/sip/" title="sip">sip </a><a class="tag" href="/tags/软件开发/" title="软件开发">软件开发 </a><a class="tag" href="/tags/webrtc/" title="webrtc">webrtc </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://mbstudio.cn/webrtc_sip_phone/,MBSTUDIO,从0开发网页webrtc sip软电话(支持自建sip服务器freeswitch),;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/cf_proxy_github_pages/" title="GITHUB Pages使用CF加速的坑">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/baidu.js"> </script></body></html>